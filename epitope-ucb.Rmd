---
title: "UCB"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(data.table)
library(dplyr)
library(ggplot2)
library(reshape2)
library(scales)
library(parallel)
library(stringr)
```

```{r}
dt.aging.stats = fread("annotations/aging_stats.txt") %>%
  mutate(count_total = count, occurrences_total = diversity, ucb = age == 0) %>%
  select(sample_id, ucb, count_total, occurrences_total)
```

Load VDJdb annotations with 1 mismatch for aging data

```{r}
dt.aging = rbindlist(mclapply(as.list(dt.aging.stats$sample_id),
                   function(x) fread(paste0("annotations/aging_split_1mm/", x, ".annot.txt")) %>% 
                     mutate(sample_id = x), mc.cores = 40)) %>%
  group_by(sample_id, cdr3) %>%
  summarise(count = sum(count), occurrences = n())
```

VDJdb data

```{r}
dt.vdjdb = fread("rearr_model/VDJDB_fullP_rob_ageing.txt") %>% 
  filter(gene == "TRB") %>%
  mutate(hla_spec = str_split_fixed(mhc.a, pattern = "[:,]", 2)[,1]) %>%
  select(cdr3, hla_spec, antigen.epitope, antigen.species) %>%
  group_by(antigen.epitope) %>%
  mutate(unique_cdrs = n()) %>%
  filter(unique_cdrs > 30) %>%
  select(cdr3, hla_spec, antigen.epitope, antigen.species)
```

Merge datasets

```{r}
dt.aging.m = dt.aging %>%
  merge(dt.vdjdb) %>%
  merge(dt.aging.stats)
```

Summarise by epitope

```{r}
dt.aging.s = dt.aging.m %>%
  group_by(ucb, antigen.epitope, antigen.species, hla_spec) %>%
  summarise(occurrences = sum(occurrences), occurrences_total = sum(as.numeric(occurrences_total)))
```

Distribution of epitopes in UCB and PBMC samples

```{r}
dt.aging.s.s = dt.aging.s %>%
  filter(ucb == T) %>%
  group_by(antigen.epitope) %>%
  summarise(freq = sum(occurrences) / sum(occurrences_total))

dt.aging.s$antigen.epitope = factor(dt.aging.s$antigen.epitope, 
                                    levels = dt.aging.s.s$antigen.epitope[order(dt.aging.s.s$freq)])

tmp = dt.aging.s %>%
  group_by(ucb, antigen.epitope) %>%
  summarise(freq = sum(occurrences) / sum(occurrences_total)) %>%
  dcast(antigen.epitope~ucb, value.var= "freq")
freq.ratios = tmp[,3] / tmp[,2]
m=mean(freq.ratios)
ci = qnorm(0.975)*sd(freq.ratios)/sqrt(length(freq.ratios))
paste(round(m,2), round(m-ci,2), round(m+ci,2))

wilcox.test(occurrences / occurrences_total ~ ucb, dt.aging.s, paired=T)

ggplot(dt.aging.s, aes(x = antigen.epitope, fill = ucb, y = occurrences / occurrences_total)) +
  geom_bar(stat="identity", position = "dodge") +
  coord_flip() +
  scale_fill_brewer(palette = "Set1") +
  xlab("") + ylab("Fraction of rearrangements") +
  theme_bw()

ggplot(dt.aging.s, aes(x = antigen.species, fill = ucb, y = occurrences / occurrences_total)) +
  geom_boxplot(aes(group = paste(antigen.species, ucb))) +
  coord_flip() +
  scale_fill_brewer(palette = "Set1") +
  xlab("") + ylab("Fraction of rearrangements") +
  theme_bw()

ggplot(dt.aging.s, aes(x = hla_spec, fill = ucb, y = occurrences / occurrences_total)) +
  geom_boxplot(aes(group = paste(hla_spec, ucb))) +
  coord_flip() +
  scale_fill_brewer(palette = "Set1") +
  xlab("") + ylab("Fraction of rearrangements") +
  theme_bw()
```