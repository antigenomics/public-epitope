---
title: "Exploratory data analysis-1"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(stringr)
library(data.table)
library(reshape2)
```

Added columns: ``genP`` full generation probability weighted by VJ usage for our data (aging); ``ageing_occur`` - number of occurrences in aging dataset, should be normalized by ``29,989,055`` - total number of rearrangements in aging data.

```{r}
TOTAL_REARRANGEMENTS_AGING = 29989055

df = read.table("VDJDB_fullP.txt", header=T, sep="\t")

# Fix issue with SLYNTVATL epitope labelled as CMV in 1555537 -> should put an issue in vdjdb-db!
# which is actually HIV
df$antigen.species = as.factor(ifelse(df$antigen.epitope == "SLYNTVATL", "HIV-1", as.character(df$antigen.species)))

df$obsP = df$ageing_occur / TOTAL_REARRANGEMENTS_AGING
```

Only intercept (constant) bias is present (from plot):

```{r}
ggplot(df, aes(x=obsP, y=genP)) +
  geom_point(shape=21)+
  geom_smooth(method="lm") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  scale_x_log10(limits = c(1e-13, 1e-3)) +
  scale_y_log10(limits = c(1e-13, 1e-3)) +
  theme_bw()

# Not quite obvious from ANOVA..

lmP = lm(log10(obsP) ~ log10(genP), subset(df, obsP > 0 & genP > 0))
summary(lmP)
anova(lmP)

# Lets try GLM

glmP = glm(obsP * TOTAL_REARRANGEMENTS_AGING ~ genP, data = df, family = poisson)
summary(glmP)
```

### Comparing genP across epitopes

Filter epitopes with few representative TCRs, remove everything with 0 generation prob

```{r}
df.tcr.per.epitope = df %>%
  filter(genP > 0) %>%
  group_by(antigen.epitope) %>%
  dplyr::summarise(count = n(), genP_med = median(genP)) %>%
  filter(count >= 30)
```

Compare rearrangement prob across epitopes and their parent species

```{r}
df.1 = subset(df, antigen.epitope %in% df.tcr.per.epitope$antigen.epitope & genP > 0)
df.1$antigen.epitope = factor(df.1$antigen.epitope, levels = df.tcr.per.epitope$antigen.epitope[order(df.tcr.per.epitope$genP_med)])

ggplot(df.1, aes(x=antigen.epitope, group = antigen.epitope, y=genP, fill = antigen.species)) +
  geom_violin() + stat_summary(fun.y=median, geom="point", shape=21, fill = "white", color="black") +
  scale_y_log10() +
  coord_flip() +
  scale_fill_brewer(palette = "Set3") +
  theme_bw()

ggplot(df.1, aes(x=antigen.species, group = antigen.species, y=genP)) +
  geom_violin() + stat_summary(fun.y=median, geom="point", shape=21, fill = "red", color="white") +
  geom_hline(yintercept = median(df.1$genP), linetype = "dashed", color = "red") +
  scale_y_log10() +
  coord_flip() +
  theme_bw()

a1 = aov(log10(genP) ~ antigen.epitope, df.1)
summary(a1)

a2 = aov(log10(genP) ~ antigen.species, df.1)
summary(a2)
TukeyHSD(a2, "antigen.species")
```

### Comparing selection prob

Pre-filter

```{r}
df.tcr.per.epitope.2 = df %>%
  filter(genP > 0 & obsP > 0) %>%
  group_by(antigen.epitope) %>%
  dplyr::summarise(count = n(), logOddsSel_med = median(log10(obsP) - log10(genP))) %>%
  filter(count >= 30)

df.2 = subset(df, antigen.epitope %in% df.tcr.per.epitope.2$antigen.epitope & genP > 0 & obsP > 0)
df.2$logOddsSel = with(df.2, log10(obsP) - log10(genP))
df.2$antigen.epitope = factor(df.2$antigen.epitope, levels = df.tcr.per.epitope.2$antigen.epitope[order(df.tcr.per.epitope.2$logOddsSel_med)])

med_log_odds = median(df.2$logOddsSel)
```

Compare selection factors

```{r}
ggplot(df.2, aes(x=antigen.epitope, group = antigen.epitope, y=logOddsSel, fill = antigen.species)) +
  geom_violin() + stat_summary(fun.y=median, geom="point", shape=21, fill = "white", color="black") +
  geom_hline(yintercept = med_log_odds, linetype = "dashed", color = "black") +
  coord_flip() +
  scale_fill_brewer(palette = "Set3") +
  theme_bw()

ggplot(df.2, aes(x=antigen.species, group = antigen.species, y=logOddsSel)) +
  geom_violin() + stat_summary(fun.y=median, geom="point", shape=21, fill = "red", color="white") +
  geom_hline(yintercept = med_log_odds, linetype = "dashed", color = "red") +
  coord_flip() +
  theme_bw()

a1 = aov(logOddsSel ~ antigen.epitope, df.2)
summary(a1)

a2 = aov(logOddsSel ~ antigen.species, df.2)
summary(a2)
TukeyHSD(a2, "antigen.species")
```

## Summary so far

- There is a difference in both rearrangement prob and selection prob across epitopes
- There is large difference in selection prob across species, no such difference for rearrangement prob
- Difference in selection prob shows that EBV and CMV are favored compared to other species. This can be due to clonal expansions, but: 1) no such difference for Flu 2) we don't account for clonal size, only counting unique rearrangements 3) A02-NLVP is not the top favoured epitope

## Features

### Epitope len for MHCI

Its more likely to generate TCR recognizing longer epitope, however the observed occurrence frequency is independent of the length of cognate epitope => differences in selection.

```{r}
df.epi = df %>% filter(mhc.class=="MHCI" & genP > 0 & obsP > 0)
df.epi$epi.len = nchar(as.character(df.epi$antigen.epitope))
df.epi.s = df.epi %>%
  group_by(epi.len) %>%
  dplyr::summarise(count = n()) %>%
  arrange(-count)
print(df.epi.s)

df.epi = df.epi %>% filter(epi.len < 12)

ggplot(df.epi, aes(x=epi.len, group=epi.len, y=genP)) +
  geom_violin() + geom_boxplot(color="red", width=0.2) +
  scale_y_log10() +
  theme_bw()

summary(lm(log10(genP) ~ epi.len, df.epi))

ggplot(df.epi, aes(x=epi.len, group=epi.len, y=obsP)) +
  geom_violin() + geom_boxplot(color="red", width=0.2) +
  scale_y_log10() +
  theme_bw()

summary(lm(log10(obsP) ~ epi.len, df.epi))

ggplot(df.epi, aes(x=epi.len, group=epi.len, y=log10(obsP)-log10(genP))) +
  geom_violin() + geom_boxplot(color="red", width=0.2) +
  theme_bw()

summary(lm(log10(obsP)-log10(genP) ~ epi.len, df.epi))
```

### Basic CDR3 features

Load annotations produced by VDJdb/Annotate

```{r}
# some dummy stuff 
df.ann = read.table("ann.aging_annot_0.txt", header = T, sep = "\t") %>%
  merge(df) %>%
  filter(obsP > 0 & genP > 0) %>%
  mutate(logOddsSel = log10(obsP) - log10(genP))
```

The only effect comes from length..

```{r}
ggplot(df.ann, aes(x=base.cdr3length / 3, y=logOddsSel)) +
  geom_violin(aes(group = base.cdr3length / 3)) + 
  geom_boxplot(aes(group = base.cdr3length / 3), color="red", width=0.2) +
  geom_smooth() +
  theme_bw()

ggplot(df.ann, aes(x=aaprop.strength, y=logOddsSel)) +
  geom_violin(aes(group = aaprop.strength)) + 
  geom_boxplot(aes(group = aaprop.strength), color="red", width=0.2) +
  geom_smooth() +
  theme_bw()

ggplot(df.ann, aes(x=aaprop.polarity, y=logOddsSel)) +
  geom_violin(aes(group = aaprop.polarity)) + 
  geom_boxplot(aes(group = aaprop.polarity), color="red", width=0.2) +
  geom_smooth() +
  theme_bw()

ggplot(df.ann, aes(x=aaprop.charge, y=logOddsSel)) +
  geom_violin(aes(group = aaprop.charge)) + 
  geom_boxplot(aes(group = aaprop.charge), color="red", width=0.2) +
  geom_smooth() +
  theme_bw()

ggplot(df.ann, aes(x=round(aaprop.hydropathy), y=logOddsSel)) +
  geom_violin(aes(group = round(aaprop.hydropathy))) + 
  geom_boxplot(aes(group = round(aaprop.hydropathy)), color="red", width=0.2) +
  geom_smooth() +
  theme_bw()
```

Note no effect from the number of strongly-interacting amino acids.

### Kidera factor sums for epitope and CDR3

Lets try Kidera factors

```{r}
kidera = t(data.frame(lapply(strsplit("A,-1.56,-1.67,-0.97,-0.27,-0.93,-0.78,-0.2,-0.08,0.21,-0.48;R,0.22,1.27,1.37,1.87,-1.7,0.46,0.92,-0.39,0.23,0.93;N,1.14,-0.07,-0.12,0.81,0.18,0.37,-0.09,1.23,1.1,-1.73;D,0.58,-0.22,-1.58,0.81,-0.92,0.15,-1.52,0.47,0.76,0.7;C,0.12,-0.89,0.45,-1.05,-0.71,2.41,1.52,-0.69,1.13,1.1;Q,-0.47,0.24,0.07,1.1,1.1,0.59,0.84,-0.71,-0.03,-2.33;E,-1.45,0.19,-1.61,1.17,-1.31,0.4,0.04,0.38,-0.35,-0.12;G,1.46,-1.96,-0.23,-0.16,0.1,-0.11,1.32,2.36,-1.66,0.46;H,-0.41,0.52,-0.28,0.28,1.61,1.01,-1.85,0.47,1.13,1.63;I,-0.73,-0.16,1.79,-0.77,-0.54,0.03,-0.83,0.51,0.66,-1.78;L,-1.04,0,-0.24,-1.1,-0.55,-2.05,0.96,-0.76,0.45,0.93;K,-0.34,0.82,-0.23,1.7,1.54,-1.62,1.15,-0.08,-0.48,0.6;M,-1.4,0.18,-0.42,-0.73,2,1.52,0.26,0.11,-1.27,0.27;F,-0.21,0.98,-0.36,-1.43,0.22,-0.81,0.67,1.1,1.71,-0.44;P,2.06,-0.33,-1.15,-0.75,0.88,-0.45,0.3,-2.3,0.74,-0.28;S,0.81,-1.08,0.16,0.42,-0.21,-0.43,-1.89,-1.15,-0.97,-0.23;T,0.26,-0.7,1.21,0.63,-0.1,0.21,0.24,-1.15,-0.56,0.19;W,0.3,2.1,-0.72,-1.57,-1.16,0.57,-0.48,-0.4,-2.3,-0.6;Y,1.38,1.48,0.8,-0.56,0,-0.68,-0.31,1.03,-0.05,0.53;V,-0.74,-0.71,2.04,-0.4,0.5,-0.81,-1.07,0.06,-0.46,0.65", ";")[[1]], function (x) { strsplit(x, ",")[[1]] } ))); kidera = data.frame(kidera[,1], apply(kidera[, 2:11], 2, as.numeric)); kidera[,1] = as.character(kidera[,1]); row.names(kidera) = kidera[,1]; names(kidera) = c("aa", "f1", "f2", "f3", "f4", "f5", "f6", "f7", "f8", "f9", "f10")
kidera$Len = 1
kidera = melt(kidera)

make_df = function(cdr3_splt) {
  data.frame(cdr3 = paste(cdr3_splt, collapse=''), aa=cdr3_splt)
}

df.cdr3.bases = rbindlist(lapply(strsplit(as.character(unique(df$cdr3)), split = ""), make_df))
df.cdr3.bases$aa = as.character(df.cdr3.bases$aa)
df.cdr3.bases = as.data.frame(df.cdr3.bases)

df.cdr3.kidera = merge(df.cdr3.bases, kidera) %>%
  group_by(cdr3, variable) %>%
  dplyr::summarise(value = sum(value))

df.cdr3.kidera.1 = merge(df.cdr3.kidera, df %>% dplyr::select(cdr3,
  mhc.class, antigen.epitope, antigen.species, genP, obsP)) %>%
  filter(genP > 0 & obsP > 0)
```

plot and compute correlation

```{r}
df.cdr3.kidera.1$logOddsSel = with(df.cdr3.kidera.1, 
                                   log10(obsP/genP))
ggplot(df.cdr3.kidera.1, aes(x=value, y=logOddsSel)) +
  geom_density2d() +
  #geom_point(shape=21, alpha=0.1) +
  geom_smooth(method="lm") +
  facet_wrap(~variable, scales = "free_x") +
  theme_bw()

for (fac in unique(df.cdr3.kidera.1$variable)) {
  print(fac)
  .df = subset(df.cdr3.kidera.1, variable == fac)
  print(cor.test(.df$logOddsSel,.df$value, method = "spearman"))
}
```

### V segments

```{r}
df.v = df %>% filter(obsP > 0 & genP) %>%
  mutate(logOddsSel = log10(obsP / genP)) %>%
  dplyr::select(v.segm, mhc.class, logOddsSel)
df.v$v.segm = str_split_fixed(as.character(df.v$v.segm), fixed("*"), 10)[,1]
df.v$v.family = str_split_fixed(as.character(df.v$v.segm), fixed("-"), 10)[,1]

df.v.count = df.v %>%
  group_by(v.segm) %>%
  dplyr::summarise(cdrs = n())

df.v = merge(df.v, df.v.count)

ggplot(df.v %>% filter(cdrs > 30), aes(x=v.segm, y=logOddsSel, color=v.family)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", color = "black") +
  coord_flip() +
  theme_bw()

a1 = aov(logOddsSel ~ v.segm, df.v %>% filter(cdrs > 30))
summary(a1)

a2 = aov(logOddsSel ~ v.family, df.v %>% filter(cdrs > 30))
summary(a2)
TukeyHSD(a2, "v.family")
```

## Further work

Need to annotate Robins data. Check HLA-mediated effect. Can we consistently rule out clonal expansions.. well we can show effect both in CMV+ and CMV- patients for specific clonotypes